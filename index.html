<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Stocks</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- General & Theming --- */
        :root {
            --bg-color: #0f0c29;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --neon-cyan: #00ffff;
            --neon-magenta: #ff00ff;
            --neon-gold: #ffd700;
            --accent-gradient: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta));
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color) url('https://www.transparenttextures.com/patterns/cubes.png');
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* --- Glassmorphism & Neon UI Components --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: #fff;
            border: none;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4), 0 0 10px rgba(0, 255, 255, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.6), 0 0 15px rgba(0, 255, 255, 0.6);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
        }
        .btn-outline:hover {
            background: var(--neon-cyan);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        h1, h2, h3 {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            margin-bottom: 15px;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        /* --- Header --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-actions button {
            margin-left: 15px;
        }

        /* --- Content Discovery --- */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
        }
        .search-bar { flex-grow: 1; }
        .filters button, .sort-select {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filters button.active {
            background: var(--accent-gradient);
            color: #fff;
            border-color: transparent;
        }

        /* --- Featured Section --- */
        .featured-section {
            margin-bottom: 40px;
        }
        .featured-carousel {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 20px; /* For scrollbar */
        }
        .featured-carousel::-webkit-scrollbar {
             height: 8px;
        }
        .featured-carousel::-webkit-scrollbar-thumb {
            background: var(--accent-gradient);
            border-radius: 10px;
        }
        .featured-item {
            flex: 0 0 300px;
            height: 180px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .featured-item:hover {
            transform: scale(1.05);
        }
        .featured-item img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .featured-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px;
            color: #fff;
        }

        /* --- Item Cards --- */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .item-card {
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px var(--neon-magenta);
        }
        .item-card-logo {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            border-bottom: 1px solid var(--glass-border);
        }
        .item-card-content { padding: 15px; }
        .item-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-card-publisher, .item-card-rating {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .item-card-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stars { color: var(--neon-gold); }
        
        /* Share button styles */
        .item-card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .share-btn {
            background: none;
            border: none;
            color: var(--neon-cyan);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .share-btn:hover {
            color: var(--neon-magenta);
            transform: scale(1.2);
        }

        /* --- Modals --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #fff;
        }
        
        #item-details-modal .modal-content { max-width: 900px; }
        .item-details-header { display: flex; gap: 20px; margin-bottom: 20px; }
        .item-details-logo { width: 120px; height: 120px; border-radius: 15px; object-fit: cover; }
        .item-details-info h2 { margin-bottom: 5px; }
        .screenshots-carousel { display: flex; gap: 10px; overflow-x: auto; margin: 20px 0; padding-bottom: 10px; }
        .screenshots-carousel img { height: 150px; border-radius: 8px; }
        .item-play-area {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* --- Reviews Section --- */
        .reviews-section h3 { margin-top: 30px; }
        .review-form-stars span { font-size: 2rem; cursor: pointer; color: var(--text-muted); }
        .review-form-stars span.selected, .review-form-stars span:hover { color: var(--neon-gold); }
        .review-card {
            border-top: 1px solid var(--glass-border);
            padding: 15px 0;
        }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .review-author { font-weight: 600; color: #fff; }
        .review-actions button { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }
        .review-actions button.liked, .review-actions button.disliked { color: var(--neon-cyan); }
        .review-replies { margin-left: 30px; margin-top: 10px; }
        .reply-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-bottom: 5px; }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
        }
        .toast {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: #fff;
            opacity: 0;
            transform: translateY(20px);
            animation: toast-in 0.5s forwards;
        }
        @keyframes toast-in {
            to { opacity: 1; transform: translateY(0); }
        }
        .toast.success { background: linear-gradient(90deg, #1d976c, #93f9b9); }
        .toast.error { background: linear-gradient(90deg, #cb2d3e, #ef473a); }

    </style>
</head>
<body>

    <!-- Header -->
    <header class="app-header glass-panel">
        <div class="logo">App Stocks</div>
        <div class="header-actions">
            <span id="welcome-message" style="margin-right: 20px;"></span>
            <button id="profile-btn" class="btn btn-outline">Profile</button>
            <button id="submit-btn" class="btn btn-primary">Submit App</button>
            <button id="logout-btn" class="btn btn-outline" style="display: none;">Logout</button>
<!-- 🔔 Notification Button -->
        <button id="notification-btn" class="btn btn-outline">🔔</button>
        </div>
    </header>

    <main class="container">
        <!-- Featured Section -->
        <section class="featured-section">
            <h2>Featured</h2>
            <div id="featured-carousel" class="featured-carousel">
                <!-- Featured items will be injected here -->
            </div>
        </section>

        <!-- Controls -->
        <div class="controls-bar glass-panel">
            <div class="filters">
                <button data-filter="All" class="active">All</button>
                <button data-filter="App">Apps</button>
                <button data-filter="Game">Games</button>
            </div>
            <select id="sort-select" class="sort-select">
                <option value="newest">Newest First</option>
                <option value="top-rated">Top Rated</option>
            </select>
            <input type="text" id="search-bar" class="search-bar" placeholder="Search for apps or games...">
        </div>

        <!-- Items Grid -->
        <section>
            <div id="items-grid" class="items-grid">
                <!-- App/Game cards will be injected here -->
            </div>
        </section>
    </main>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Modals -->
    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content glass-panel">
            <span class="modal-close">&times;</span>
            <h2>Your Profile</h2>
            <p>A profile is needed to submit, review, and vote.</p>
            <form id="profile-form">
                <input type="text" id="display-name" placeholder="Display Name" required>
                <input type="email" id="email-address" placeholder="Email Address" required>
                <button type="submit" class="btn btn-primary">Save Profile</button>
            </form>
        </div>
    </div>

    <!-- Submission Modal -->
    <div id="submission-modal" class="modal">
        <div class="modal-content glass-panel">
            <span class="modal-close">&times;</span>
            <h2>Submit an App or Game</h2>
            <form id="submission-form">
                <input type="text" id="submission-title" placeholder="Title" required>
                <textarea id="submission-desc" placeholder="Description" rows="4" required></textarea>
                <input type="url" id="submission-logo" placeholder="Logo Image URL" required>
                <input type="text" id="submission-screenshots" placeholder="Screenshots (comma-separated URLs)">
                <select id="submission-type" required>
                    <option value="">Select Type...</option>
                    <option value="App">App</option>
                    <option value="Game">Game</option>
                </select>
                <select id="submission-content-type" required>
                    <option value="">Select Submission Type...</option>
                    <option value="embed">HTML Embed</option>
                    <option value="link">External Link</option>
                </select>
                <textarea id="submission-embed-code" placeholder="Paste <iframe> or HTML code here" rows="5" style="display:none;"></textarea>
                <input type="url" id="submission-download-link" placeholder="External Download URL" style="display:none;">
                <input type="hidden" id="update-of-id">
                <p>To request an update for your published app, find it in the list, click "Request Update" and fill this form.</p>
                <button type="submit" class="btn btn-primary">Submit for Review</button>
            </form>
        </div>
    </div>
    
    <!-- Item Details Modal -->
    <div id="item-details-modal" class="modal">
        <div class="modal-content glass-panel">
            <span class="modal-close">&times;</span>
            <div id="item-details-content">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
    // --- FIREBASE CONFIGURATION ---
  const firebaseConfig = {
  apiKey: "AIzaSyCyeCIbVLKxlG8ZnD7Pgd0396IMpAPGpqE",
  authDomain: "app-store-stocks.firebaseapp.com",
  databaseURL: "https://app-store-stocks-default-rtdb.firebaseio.com",
  projectId: "app-store-stocks",
  storageBucket: "app-store-stocks.firebasestorage.app",
  messagingSenderId: "1066420357396",
  appId: "1:1066420357396:web:99348a13f243bfb5601a01"

};


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- GLOBAL STATE & DOM ELEMENTS ---
    let userProfile = null;
    let allItems = {};
    let currentFilter = 'All';
    let currentSort = 'newest';
    let currentSearch = '';

    const DOM = {
        welcomeMessage: document.getElementById('welcome-message'),
        profileBtn: document.getElementById('profile-btn'),
        submitBtn: document.getElementById('submit-btn'),
        logoutBtn: document.getElementById('logout-btn'),
        itemsGrid: document.getElementById('items-grid'),
        featuredCarousel: document.getElementById('featured-carousel'),
        filterButtons: document.querySelectorAll('.filters button'),
        sortSelect: document.getElementById('sort-select'),
        searchBar: document.getElementById('search-bar'),
        // Modals
        profileModal: document.getElementById('profile-modal'),
        submissionModal: document.getElementById('submission-modal'),
        itemDetailsModal: document.getElementById('item-details-modal'),
    };
    
    // --- UTILITY FUNCTIONS ---
    const sanitizeEmail = (email) => email.replace(/[.#$[\]]/g, "_");
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    };

    // --- PROFILE MANAGEMENT ---
    function checkUserProfile() {
        const profile = localStorage.getItem('userProfile');
        if (profile) {
            userProfile = JSON.parse(profile);
            DOM.welcomeMessage.textContent = `Welcome, ${userProfile.displayName}!`;
            DOM.profileBtn.style.display = 'none';
            DOM.logoutBtn.style.display = 'inline-block';
            listenForNotifications();
        } else {
            DOM.welcomeMessage.textContent = '';
            DOM.profileBtn.style.display = 'inline-block';
            DOM.logoutBtn.style.display = 'none';
        }
    }

    function saveProfile(e) {
        e.preventDefault();
        const displayName = document.getElementById('display-name').value;
        const email = document.getElementById('email-address').value;
        if (displayName && email) {
            userProfile = { displayName, email };
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            checkUserProfile();
            DOM.profileModal.classList.remove('active');
            showToast('Profile saved successfully!');
        }
    }

    function logout() {
        localStorage.removeItem('userProfile');
        userProfile = null;
        checkUserProfile();
        showToast('You have been logged out.');
    }
    
// Notification button redirect
document.getElementById('notification-btn').addEventListener('click', () => {
    window.location.href = 'notifications.html';
});


    // --- NOTIFICATIONS ---
    function listenForNotifications() {
        if (!userProfile) return;
        const sanitizedEmail = sanitizeEmail(userProfile.email);
        const notificationsRef = database.ref(`notifications/${sanitizedEmail}`);

        notificationsRef.on('child_added', (snapshot) => {
            const notification = snapshot.val();
            if (!notification.seen) {
                const message = `Your submission "${notification.title}" was ${notification.status}.`;
                showToast(message, notification.status === 'approved' ? 'success' : 'error');
                notificationsRef.child(snapshot.key).update({ seen: true });
            }
        });
    }

    // --- CONTENT RENDERING ---
    function renderItems() {
        DOM.itemsGrid.innerHTML = '';
        DOM.featuredCarousel.innerHTML = '';
        
        let itemsArray = Object.keys(allItems).map(key => ({ id: key, ...allItems[key] }));

        // 1. Filter
        if (currentFilter !== 'All') {
            itemsArray = itemsArray.filter(item => item.type === currentFilter);
        }

        // 2. Search
        if (currentSearch) {
            itemsArray = itemsArray.filter(item => 
                item.title.toLowerCase().includes(currentSearch) ||
                item.description.toLowerCase().includes(currentSearch)
            );
        }

        // 3. Sort
        itemsArray.sort((a, b) => {
            if (currentSort === 'newest') {
                return b.publishedAt - a.publishedAt;
            } else if (currentSort === 'top-rated') {
                return (b.avgRating || 0) - (a.avgRating || 0);
            }
            return 0;
        });
        
        // Render Featured Carousel (from original unfiltered list)
        Object.values(allItems).filter(item => item.isFeatured).forEach(item => {
             const featuredDiv = document.createElement('div');
             featuredDiv.className = 'featured-item';
             featuredDiv.dataset.id = Object.keys(allItems).find(key => allItems[key] === item);
             featuredDiv.innerHTML = `
                <img src="${item.logoUrl}" alt="${item.title}">
                <div class="overlay"><h3>${item.title}</h3></div>
             `;
             featuredDiv.addEventListener('click', () => showItemDetails(featuredDiv.dataset.id));
             DOM.featuredCarousel.appendChild(featuredDiv);
        });

        // Render Grid
        itemsArray.forEach(item => {
            const card = document.createElement('div');
            card.className = 'item-card glass-panel';
            card.dataset.id = item.id;
            const avgRating = item.avgRating ? item.avgRating.toFixed(1) : 'N/A';
            const totalRatings = item.totalRatings || 0;
            
            card.innerHTML = `
                <div class="item-card-logo" style="background-image: url('${item.logoUrl}')"></div>
                <div class="item-card-content">
                    <h3 class="item-card-title">${item.title}</h3>
                    <p class="item-card-publisher">by ${item.publisherName}</p>
                    <div class="item-card-rating">
                        <span class="stars">★★★★★</span>
                        <span>${avgRating} (${totalRatings} ratings)</span>
                    </div>
                    <div class="item-card-actions">
                        <button class="share-btn" data-id="${item.id}" title="Share this app">🔗</button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            card.addEventListener('click', (e) => {
                // Don't open details if share button was clicked
                if (!e.target.classList.contains('share-btn')) {
                    showItemDetails(item.id);
                }
            });
            
            // Share button event listener
            const shareBtn = card.querySelector('.share-btn');
            shareBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card click event
                shareItem(item.id);
            });
            
            DOM.itemsGrid.appendChild(card);
        });
    }

    function loadItems() {
        database.ref('items').on('value', (snapshot) => {
            allItems = snapshot.val() || {};
            renderItems();
        });
    }

    // --- SHARE FUNCTIONALITY ---
    function shareItem(itemId) {
        // Generate shareable URL with item ID
        const baseUrl = window.location.origin + window.location.pathname;
        const shareableUrl = `${baseUrl}?item=${itemId}`;
        
        // Copy to clipboard
        navigator.clipboard.writeText(shareableUrl).then(() => {
            showToast('Link copied to clipboard!');
        }).catch(err => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = shareableUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('Link copied to clipboard!');
        });
    }

    // --- ITEM DETAILS MODAL ---
    async function showItemDetails(itemId) {
        const item = allItems[itemId];
        if (!item) return;

        const detailsContent = document.getElementById('item-details-content');
        detailsContent.innerHTML = `
            <div class="item-details-header">
                <img src="${item.logoUrl}" alt="${item.title}" class="item-details-logo">
                <div class="item-details-info">
                    <h2>${item.title}</h2>
                    <p>by ${item.publisherName}</p>
                    <div class="item-card-rating">
                        <span class="stars">★★★★★</span>
                        <span>${(item.avgRating || 0).toFixed(1)} (${item.totalRatings || 0} ratings)</span>
                    </div>
                </div>
            </div>
            <p>${item.description}</p>
            ${item.screenshots && item.screenshots.length > 0 ? `
                <div class="screenshots-carousel">
                    ${item.screenshots.map(url => `<img src="${url}" alt="screenshot">`).join('')}
                </div>` : ''
            }
            <div id="action-buttons-container"></div>
            <div id="play-area-container"></div>
            <div class="reviews-section">
                <h3>Reviews & Ratings</h3>
                <div id="review-form-container"></div>
                <div id="reviews-list"></div>
            </div>
        `;
        
        // Action buttons
        const actionContainer = detailsContent.querySelector('#action-buttons-container');
        if (item.submissionType === 'embed') {
            actionContainer.innerHTML = `<button class="btn btn-primary" id="play-btn">Play Now</button>`;
            actionContainer.querySelector('#play-btn').onclick = () => {
                detailsContent.querySelector('#play-area-container').innerHTML = `<iframe class="item-play-area" srcdoc="${item.embedCode}"></iframe>`;
            };
        } else {
            actionContainer.innerHTML = `<a href="${item.downloadLink}" target="_blank" class="btn btn-primary">Download</a>`;
        }
        actionContainer.innerHTML += `<button class="btn btn-outline" id="update-request-btn" data-id="${itemId}" style="margin-left:10px;">Request Update</button>`;
        actionContainer.innerHTML += `<button class="btn btn-outline" id="share-details-btn" data-id="${itemId}" style="margin-left:10px;">Share</button>`;
        
        // Share button in details modal
        detailsContent.querySelector('#share-details-btn').onclick = () => {
            shareItem(itemId);
        };
        
        detailsContent.querySelector('#update-request-btn').onclick = () => openSubmissionFormForUpdate(itemId);

        renderReviewForm(itemId);
        loadAndRenderReviews(itemId);
        DOM.itemDetailsModal.classList.add('active');
    }
    
    // --- REVIEW SYSTEM ---
    function renderReviewForm(itemId) {
        const container = document.getElementById('review-form-container');
        if (!userProfile) {
            container.innerHTML = '<p>You must have a profile to leave a review.</p>';
            return;
        }

        container.innerHTML = `
            <form id="review-form" class="glass-panel" style="margin-bottom:20px;">
                <h4>Leave a Review</h4>
                <div class="review-form-stars" data-rating="0">
                    <span data-value="1">★</span><span data-value="2">★</span><span data-value="3">★</span><span data-value="4">★</span><span data-value="5">★</span>
                </div>
                <textarea id="review-comment" placeholder="Optional comment..." rows="3"></textarea>
                <button type="submit" class="btn btn-primary">Submit Review</button>
            </form>
        `;

        const stars = container.querySelectorAll('.review-form-stars span');
        stars.forEach(star => {
            star.addEventListener('click', () => {
                const rating = star.dataset.value;
                container.querySelector('.review-form-stars').dataset.rating = rating;
                stars.forEach(s => s.classList.toggle('selected', s.dataset.value <= rating));
            });
        });

        document.getElementById('review-form').addEventListener('submit', (e) => submitReview(e, itemId));
    }
    
    function submitReview(e, itemId) {
        e.preventDefault();
        const rating = parseInt(document.querySelector('.review-form-stars').dataset.rating);
        const comment = document.getElementById('review-comment').value;

        if (rating === 0) {
            showToast('Please select a star rating.', 'error');
            return;
        }
        
        const reviewData = {
            userId: sanitizeEmail(userProfile.email),
            username: userProfile.displayName,
            rating,
            comment,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: 0,
            dislikes: 0
        };

        const reviewRef = database.ref(`reviews/${itemId}`).push();
        const itemRef = database.ref(`items/${itemId}`);

        // Check if user already reviewed
        database.ref(`reviews/${itemId}`).orderByChild('userId').equalTo(reviewData.userId).once('value', snapshot => {
            if (snapshot.exists()) {
                showToast('You have already reviewed this item.', 'error');
                return;
            }
            
            // Submit review and update item rating atomically
            reviewRef.set(reviewData);
            itemRef.transaction(item => {
                if (item) {
                    item.totalRatings = (item.totalRatings || 0) + 1;
                    item.sumOfRatings = (item.sumOfRatings || 0) + rating;
                    item.avgRating = item.sumOfRatings / item.totalRatings;
                }
                return item;
            });

            showToast('Review submitted!');
            document.getElementById('review-form').reset();
            document.querySelectorAll('.review-form-stars span').forEach(s => s.classList.remove('selected'));
        });
    }

    function loadAndRenderReviews(itemId) {
        const reviewsList = document.getElementById('reviews-list');
        database.ref(`reviews/${itemId}`).on('value', snapshot => {
            reviewsList.innerHTML = '';
            if (!snapshot.exists()) {
                reviewsList.innerHTML = '<p>No reviews yet.</p>';
                return;
            }
            snapshot.forEach(childSnapshot => {
                const reviewId = childSnapshot.key;
                const review = childSnapshot.val();
                
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                reviewCard.innerHTML = `
                    <div class="review-header">
                        <div>
                            <span class="review-author">${review.username}</span> - <span class="stars">${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}</span>
                        </div>
                        <div class="review-actions">
                            <button class="vote-btn" data-type="like" data-item="${itemId}" data-review="${reviewId}">👍 ${review.likes}</button>
                            <button class="vote-btn" data-type="dislike" data-item="${itemId}" data-review="${reviewId}">👎 ${review.dislikes}</button>
                            <button class="reply-btn">Reply</button>
                            ${userProfile && sanitizeEmail(userProfile.email) === review.userId ? `<button class="delete-review-btn" data-item="${itemId}" data-review="${reviewId}" data-rating="${review.rating}">Delete</button>` : ''}
                        </div>
                    </div>
                    <p class="review-comment">${review.comment}</p>
                    <div class="review-replies"></div>
                    <div class="reply-form" style="display:none; margin-left:30px; margin-top:10px;">
                        <textarea placeholder="Write a reply..."></textarea>
                        <button class="btn btn-primary btn-sm submit-reply-btn" data-item="${itemId}" data-review="${reviewId}">Post</button>
                    </div>
                `;
                reviewsList.appendChild(reviewCard);

                // Render replies
                if(review.replies) {
                    const repliesContainer = reviewCard.querySelector('.review-replies');
                    Object.values(review.replies).forEach(reply => {
                        repliesContainer.innerHTML += `
                          <div class="reply-card">
                            <strong>${reply.username}:</strong> ${reply.text}
                          </div>
                        `;
                    });
                }
            });
        });
    }

    function handleReviewInteraction(e) {
        const target = e.target;
        if(target.classList.contains('vote-btn')) {
             voteOnReview(target.dataset.item, target.dataset.review, target.dataset.type);
        }
        if (target.classList.contains('delete-review-btn')) {
            deleteReview(target.dataset.item, target.dataset.review, parseInt(target.dataset.rating));
        }
        if (target.classList.contains('reply-btn')) {
            target.closest('.review-card').querySelector('.reply-form').style.display = 'block';
        }
        if (target.classList.contains('submit-reply-btn')) {
            const replyText = target.previousElementSibling.value;
            postReply(target.dataset.item, target.dataset.review, replyText);
        }
    }

    function voteOnReview(itemId, reviewId, voteType) {
        if (!userProfile) { showToast('You need a profile to vote.', 'error'); return; }

        const voteRecord = JSON.parse(localStorage.getItem('reviewVotes')) || {};
        if (voteRecord[reviewId]) {
            showToast('You have already voted on this review.', 'error');
            return;
        }

        const reviewRef = database.ref(`reviews/${itemId}/${reviewId}`);
        reviewRef.child(voteType + 's').set(firebase.database.ServerValue.increment(1));
        
        voteRecord[reviewId] = voteType;
        localStorage.setItem('reviewVotes', JSON.stringify(voteRecord));
        showToast('Vote counted!');
    }
    
    function deleteReview(itemId, reviewId, rating) {
        if (!confirm('Are you sure you want to delete your review?')) return;

        database.ref(`reviews/${itemId}/${reviewId}`).remove();
        database.ref(`items/${itemId}`).transaction(item => {
            if (item) {
                item.totalRatings = (item.totalRatings || 1) - 1;
                item.sumOfRatings = (item.sumOfRatings || rating) - rating;
                item.avgRating = item.totalRatings > 0 ? item.sumOfRatings / item.totalRatings : 0;
            }
            return item;
        });
        showToast('Review deleted.');
    }

    function postReply(itemId, reviewId, text) {
         if (!userProfile) { showToast('You need a profile to reply.', 'error'); return; }
         if (!text.trim()) return;

         const replyData = {
             userId: sanitizeEmail(userProfile.email),
             username: userProfile.displayName,
             text,
             timestamp: firebase.database.ServerValue.TIMESTAMP
         };
         database.ref(`reviews/${itemId}/${reviewId}/replies`).push(replyData);
    }
    
    // --- SUBMISSIONS ---
    function openSubmissionForm() {
        if (!userProfile) {
            showToast('Please create a profile first to submit content.', 'error');
            DOM.profileModal.classList.add('active');
            return;
        }
        document.getElementById('submission-form').reset();
        document.getElementById('update-of-id').value = '';
        DOM.submissionModal.classList.add('active');
    }
    
    function openSubmissionFormForUpdate(itemId) {
        openSubmissionForm();
        const item = allItems[itemId];
        if (userProfile.email !== item.publisherEmail) {
            showToast("You can only request updates for your own apps.", "error");
            return;
        }
        document.getElementById('submission-title').value = item.title;
        document.getElementById('submission-desc').value = item.description;
        document.getElementById('submission-logo').value = item.logoUrl;
        document.getElementById('update-of-id').value = itemId;
        DOM.itemDetailsModal.classList.remove('active');
    }

    function handleSubmission(e) {
        e.preventDefault();
        const submissionData = {
            title: document.getElementById('submission-title').value,
            description: document.getElementById('submission-desc').value,
            logoUrl: document.getElementById('submission-logo').value,
            screenshots: document.getElementById('submission-screenshots').value.split(',').map(s => s.trim()).filter(s => s),
            type: document.getElementById('submission-type').value,
            submissionType: document.getElementById('submission-content-type').value,
            embedCode: document.getElementById('submission-embed-code').value,
            downloadLink: document.getElementById('submission-download-link').value,
            submitterName: userProfile.displayName,
            submitterEmail: userProfile.email,
            updateOf: document.getElementById('update-of-id').value || null
        };

        database.ref('pendingSubmissions').push(submissionData)
            .then(() => {
                showToast('Your submission has been sent for review!');
                DOM.submissionModal.classList.remove('active');
                e.target.reset();
            })
            .catch(err => showToast(`Submission failed: ${err.message}`, 'error'));
    }

    // --- EVENT LISTENERS ---
    window.addEventListener('DOMContentLoaded', () => {
        checkUserProfile();
        loadItems();
        
        // Check for direct item link in URL
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('item');
        if (itemId) {
            // Load items first, then show the specific item
            database.ref('items').once('value', (snapshot) => {
                allItems = snapshot.val() || {};
                if (allItems[itemId]) {
                    showItemDetails(itemId);
                } else {
                    showToast('App not found', 'error');
                }
            });
        }
        
        // Modal controls
        DOM.profileBtn.addEventListener('click', () => DOM.profileModal.classList.add('active'));
        DOM.submitBtn.addEventListener('click', openSubmissionForm);
        DOM.logoutBtn.addEventListener('click', logout);
        
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal').classList.remove('active');
            });
        });

        // Forms
        document.getElementById('profile-form').addEventListener('submit', saveProfile);
        document.getElementById('submission-form').addEventListener('submit', handleSubmission);

        // Submission Type Toggle
        document.getElementById('submission-content-type').addEventListener('change', e => {
            const isEmbed = e.target.value === 'embed';
            document.getElementById('submission-embed-code').style.display = isEmbed ? 'block' : 'none';
            document.getElementById('submission-download-link').style.display = isEmbed ? 'none' : 'block';
        });

        // Filtering and Sorting
        DOM.filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                DOM.filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentFilter = button.dataset.filter;
                renderItems();
            });
        });
        DOM.sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderItems();
        });
        DOM.searchBar.addEventListener('keyup', (e) => {
            currentSearch = e.target.value.toLowerCase();
            renderItems();
        });

        // Event delegation for dynamic content
        document.body.addEventListener('click', handleReviewInteraction);
    });

    </script>
</body>
</html>
